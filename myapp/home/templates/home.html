{% extends '/body.html' %}
{% block content %}
    <div class="container">
        <div class="row w-75 container-center">
            <div class="col">
                <h1 class="text-center mt-5 mb-0 mb-3">Shorten a long URL</h1>
                <div class="toolbox">
                    <div class="row">
                        <p-input :com-props="longURLProps" :global-props="globalProps"></p-input>
                        <div v-if="!globalProps.isVisibleZipURLResult" class="col" v-cloak>
                            <div class="row">
                                <div class="col-4">
                                    <p-input :com-props="domainProps" :global-props="globalProps"></p-input>
                                </div>
                                <div class="col-8">
                                    <p-input :com-props="aliasProps" :global-props="globalProps"></p-input>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div v-if="!globalProps.isVisibleZipURLResult"  class="row" v-cloak>
                         <div class="col text-center">
                            <p-button :com-props="zipLinkBtn" @button-clicked="handleZipURL"></p-button>
                        </div>
                    </div>
                    <div v-if="globalProps.isVisibleZipURLResult" class="row" v-cloak>
                        <div class="col-md-8 col-sm-12">
                            <p-input :com-props="shortURLProps" :global-props="globalProps"></p-input>
                            <div class="text-center">
                                <button class="btn btn-secondary btn-large mx-2" data-bs-toggle="offcanvas"
                                        data-bs-target="#offcanvas-urls-recent" aria-controls="staticBackdrop">
                                    My URLs
                                </button>
                                <p-button :com-props="zipOtherBtn" @button-clicked="handleZipOtherURL"></p-button>
                            </div>
                        </div>
                         <div class="col-md-4">
                            <div class="text-center">
                                <div class="qrcode-box overflow-hidden">
                                    <img
                                        :src="resultURLProps.qrcodeImage"
                                        alt="QR Code" class="img-fluid">
                                        <a :href="resultURLProps.qrcodeURL"
                                            class="link-success link-offset-2 link-underline-opacity-25 link-underline-opacity-100-hover btn-download-qrcode">Download</a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="offcanvas offcanvas-end non-user-history-width" data-bs-backdrop="static" tabindex="-1"
                         id="offcanvas-urls-recent" aria-labelledby="staticBackdropLabel">
                        <div class="offcanvas-header"><h5 class="offcanvas-title" id="offcanvasExampleLabel">Your recent
                            URLs</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="offcanvas"
                                    aria-label="Close"></button>
                        </div>
                        <div class="offcanvas-body">
                            <div class="row mb-2">
                                <div content="col">
                                    <div class="w-100 text-center">
                                        <div class="spinner-border text-center" role="status"><span
                                                class="visually-hidden">Loading...</span></div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class=""></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="toast-container position-fixed bottom-0 end-0 p-3">
                    <div id="live_toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="toast-header"><strong class="me-auto"></strong><small></small>
                            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                        </div>
                        <div class="toast-body"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
<script type="module">


const { createApp, ref, onMounted, OnErrorCaptured } = Vue;
import PInput from '{{ url_for('static', filename='js/components/p-input.js') }}';
import PButton from '{{ url_for('static', filename='js/components/p-button.js') }}';
    createApp({
        setup() {
            onMounted(() => {
                let zipit_uuid = Cookies.get('Zipit-Uuid');
                if ( zipit_uuid === undefined ) {
                  zipit_uuid = helper.getMetaContent('Zipit-Uuid')
                  Cookies.set('Zipit-Uuid', zipit_uuid, { expires: 365 });
                }
                console.log(zipit_uuid)
                window.axios.defaults.headers.common['Zipit-Uuid'] = zipit_uuid;

            });
            const helper = new Helper();
            const long_url = ref('');
            const alias_name = ref('');
            const globalProps= ref({
                'helper': new Helper(),
                'axios': window.axios,
                'isVisibleZipURLResult': false,
            });
            const longURLProps = ref({
                placeHolder: 'Ex: https://yourdomain.com/url-too-long',
                label: 'Paste a long URL',
            });
            const domainProps = ref({
                placeHolder: 'zipit.link',
                label: 'Domain',
                disabled: true
            });
            const aliasProps = ref({
                placeHolder: 'Ex: my-link',
                label: 'Enter a back-half you want (optional)',
            });
            const shortURLProps = ref({
                placeHolder: 'https://zipit.link/your-link',
                label: 'Your shorten URLs',
                disabled: true,
                type: 'inputGroup'
            });
            const zipLinkBtn = ref({
                label: 'Zip Your URL',
                class: 'btn btn-primary',
            });
            const zipOtherBtn = ref({
                label: 'Zip another URL',
                class: 'btn btn-primary',
            });
            const resultURLProps = ref({
                shortURL: '',
                publicID: '',
                qrcodeImage: '',
                qrcodeURL: '',
                listAlias: []
            });
            const handleZipURL = async () => {
                console.log("CLICKED")
                let payload = {
                    'long_url': longURLProps.value.val,
                    'alias': alias_name.value.val
                }
                window.axios.post('/zip-url', payload)
                    .then((response) => {
                        console.log(response.data)
                        longURLProps.value.disabled = true;
                        globalProps.value.isVisibleZipURLResult = true;
                        resultURLProps.value.publicID = response.data.public_id;
                        resultURLProps.value.shortURL = response.data.short_link;
                        resultURLProps.value.qrcodeImage = response.data.qrcode_base64;
                        resultURLProps.value.listAlias = response.data.list_alias;
                        resultURLProps.value.qrcodeURL = response.data.qrcode;
                        shortURLProps.value.val = response.data.short_link;
                        console.log(response.data)
                    })
                    .catch((error) => {
                        console.log(error)
                    })
            }
            const handleZipOtherURL = () => {
                globalProps.value.isVisibleZipURLResult = false;
                longURLProps.value.disabled = false;
                aliasProps.value.disabled = false;
                longURLProps.value.val = '';
                aliasProps.value.val = '';
                shortURLProps.value.val = '';
            }
            return {
                helper,
                long_url,
                alias_name,
                longURLProps,
                domainProps,
                aliasProps,
                zipLinkBtn,
                globalProps,
                shortURLProps,
                resultURLProps,
                zipOtherBtn,
                handleZipURL,
                handleZipOtherURL
            }
        },
        delimiters: ['${', '}'],
        components: {
            'p-input': PInput,
            'p-button': PButton
        }
    })
    .mount('#app');
</script>
{% endblock %}